<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: client-side/download.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: client-side/download.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*eslint-env browser*/
(() => {
	require('/client-side/common.js');
	const assert = require('/lib/assert.js');
	const base64 = require('base64-js');
	const r = require('/read.js');
	const typeCache = {};
	function saveTypeCache() {
		const composedCache = {};
		for (const type in typeCache) {
			composedCache[type] = {
				sig: typeCache[type].sig,
				type: base64.fromByteArray(new Uint8Array(typeCache[type].type.toBuffer()))
			};
		}
		localStorage.typeCache = JSON.stringify(composedCache);
	}
	if (localStorage.typeCache === undefined) saveTypeCache();
	else {
		const composedCache = JSON.parse(localStorage.typeCache);
		for (const typeName in composedCache) {
			typeCache[typeName] = {
				sig: composedCache[typeName].sig,
				type: r.type(new Uint8Array(base64.toByteArray(composedCache[typeName].type)).buffer)
			};
		}
	}
	/** @function
	 * @name download
	 * @desc &lt;b>(client-side only)&lt;/b>
	 * Downloads a value using an AJAX request.
	 * The type will be sent from the server if not in the client's cache.
	 * If the client has already cached the correct type, only the value will be sent.
	 * To use, include {@link compiled/download.js} or {@link compiled/upload-download.js}.
	 * @param {string} typeName An identifier for the type being downloaded.
	 * The downloaded type will be cached under this name
	 * and future requests that use the same {@link typeName}
	 * will try to use the type data cached in [localStorage]{@link https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage}.
	 * To best utilize the cache,
	 * use different type names for requests of different types
	 * and use the same type name for requests of the same type.
	 * @param {Object} options [jQuery AJAX options]{@link https://api.jquery.com/jquery.ajax/#jQuery-ajax-settings}.
	 * These options should specify what URL to use, what to do on success, etc.
	 * {@link options.dataType} will be overwritten.
	 * @example
	 * sb.download('people', {
	 *   url: '/download-people',
	 *   type: 'GET',
	 *   success: function(value) {
	 *     console.log(value); //e.g. [{name: 'John', id: 2}, {name: 'Jane', id: 10}]
	 *   }
	 * });
	 */
	window.sb.download = (typeName, options) => {
		assert.instanceOf(typeName, String);
		assert.instanceOf(options, Object);
		options.dataType = 'arraybuffer';
		let typeInCache;
		if (typeCache[typeName]) {
			typeInCache = true;
			if (!options.headers) options.headers = {};
			options.headers.sig = typeCache[typeName].sig;
		}
		else typeInCache = false;
		let oldSuccess = options.success;
		function success(value, textStatus, jqXHR) {
			if (oldSuccess) {
				if (!(oldSuccess instanceof Array)) oldSuccess = [oldSuccess];
				for (const success of oldSuccess) success(value, textStatus, jqXHR);
			}
		}
		options.success = (data, textStatus, jqXHR) => {
			const sig = jqXHR.getResponseHeader('sig');
			if (typeInCache &amp;&amp; typeCache[typeName].sig === sig) {
				const type = typeCache[typeName].type;
				const value = r.value({buffer: data, type});
				success(value, textStatus, jqXHR);
			}
			else {
				const readType = r._consumeType(data, 0);
				const value = r.value({buffer: data, offset: readType.length, type: readType.value});
				const type = readType.value;
				typeCache[typeName] = {sig, type};
				saveTypeCache();
				success(value, textStatus, jqXHR);
			}
		};
		$.ajax(options); //eslint-disable-line no-undef
	};
})();</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Externals</h3><ul><li><a href="external-ArrayBuffer.html">ArrayBuffer</a></li><li><a href="external-http.html">http</a></li></ul><h3>Classes</h3><ul><li><a href="ArrayType.html">ArrayType</a></li><li><a href="BigIntType.html">BigIntType</a></li><li><a href="BigUnsignedIntType.html">BigUnsignedIntType</a></li><li><a href="BooleanArrayType.html">BooleanArrayType</a></li><li><a href="BooleanTupleType.html">BooleanTupleType</a></li><li><a href="BooleanType.html">BooleanType</a></li><li><a href="BufferStream.html">BufferStream</a></li><li><a href="ByteType.html">ByteType</a></li><li><a href="CharType.html">CharType</a></li><li><a href="ChoiceType.html">ChoiceType</a></li><li><a href="DateType.html">DateType</a></li><li><a href="DoubleType.html">DoubleType</a></li><li><a href="EnumType.html">EnumType</a></li><li><a href="external-http.IncomingMessage.html">IncomingMessage</a></li><li><a href="external-http.ServerResponse.html">ServerResponse</a></li><li><a href="FloatType.html">FloatType</a></li><li><a href="GrowableBuffer.html">GrowableBuffer</a></li><li><a href="IntType.html">IntType</a></li><li><a href="LongType.html">LongType</a></li><li><a href="MapType.html">MapType</a></li><li><a href="OctetsType.html">OctetsType</a></li><li><a href="OptionalType.html">OptionalType</a></li><li><a href="PointerType.html">PointerType</a></li><li><a href="SetType.html">SetType</a></li><li><a href="ShortType.html">ShortType</a></li><li><a href="StringType.html">StringType</a></li><li><a href="StructType.html">StructType</a></li><li><a href="TupleType.html">TupleType</a></li><li><a href="Type.html">Type</a></li><li><a href="UnsignedByteType.html">UnsignedByteType</a></li><li><a href="UnsignedIntType.html">UnsignedIntType</a></li><li><a href="UnsignedLongType.html">UnsignedLongType</a></li><li><a href="UnsignedShortType.html">UnsignedShortType</a></li></ul><h3>Namespaces</h3><ul><li><a href="r.html">r</a></li></ul><h3>Global</h3><ul><li><a href="global.html#download">download</a></li><li><a href="global.html#httpRespond">httpRespond</a></li><li><a href="global.html#readType">readType</a></li><li><a href="global.html#readTypeAndValue">readTypeAndValue</a></li><li><a href="global.html#readValue">readValue</a></li><li><a href="global.html#upload">upload</a></li><li><a href="global.html#writeType">writeType</a></li><li><a href="global.html#writeTypeAndValue">writeTypeAndValue</a></li><li><a href="global.html#writeValue">writeValue</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
